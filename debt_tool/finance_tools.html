<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <link rel="stylesheet" href="financetools.css" />
   <title>Finance Tools</title>
   <h1>Debt Payoff Calculator</h1>
   <h2>
       This program gives you the mathematically best way to pay off your debt, using the avalanche method.
       After making all minimum payments, additional payments are preferentially directed to paying down debt 
       with the highest interest first. In order to get out of high interest debt, we recommend only spending
       money on neccessary expenses and putting the rest towards your debt. This would minimize the time needed 
       for debt payoff and the total interest paid.
   </h2>
   <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

   <style> 
        h2 {
            font-size: 20px;
        }

        .symbol {
            position: absolute;
            transform: translate(2px, 1px);
        }

        .dollar-textbox {
            padding-left: 10px;
        }

        .percent-symbol {
            position: absolute;
            transform: translate(-20px, 1px);
        }

        .percent-textbox {
            padding-right: 20px;
        }


   </style>

</head>

<body>
    <label for="debtNum">Number of Debts(not including mortgage):</label>
    <input type="text" id="debtNum" name="debtNum" placeholder="0">

    <button onclick="addDebts()">Enter</button>

    <script>
    
        var startDebt = 0;

        var containers = [];

        function addDebts() {
            Clear();
            var debtNum = parseInt(document.getElementById("debtNum").value.replace(",",""));
            if (!isNaN(debtNum)) {

                if (debtNum < 0) {
                    alert("You're not funny, please enter a valid number.");
                    return 0;
                } else if (debtNum == 69) {
                    alert("nice");
                }

                var existingButton = document.getElementById("addButton");
                if (existingButton) {
                    document.body.removeChild(existingButton);
                }

                var incomeTest = document.getElementById("income");
                if (incomeTest) {
                    var currIncome = (document.getElementById("income").value).toString();
                } 
               
                var incContainer = document.getElementById("incContainer");
                if (incContainer) {
                    document.body.removeChild(incContainer);
                }


                if (startDebt > debtNum) {
                    var difference = startDebt - debtNum;
                    for (var z = 0; z < difference; z++) {

                        var lastContainer = containers.pop();
                        document.body.removeChild(lastContainer);
                        startDebt = startDebt - 1;
                    }

                } else {
                     
                    for (var i = startDebt; i < debtNum; i++) {
                        startDebt = startDebt + 1;
                        var container = document.createElement("div");
                        container.appendChild(document.createElement("br"));
                        document.body.appendChild(container);
                        
                        for (var y = 0; y < 4; y++) {
                                
                            var label = document.createElement("label");

                            var newInput = document.createElement("input");
                            newInput.type = "text";
                            newInput.name = "dynamicInput";
                            newInput.placeholder = "enter";

                            if (y == 0) { 
                               
                                label.for = "debtName" + (i+1);
                                label.innerHTML = " Debt " + (i + 1) + " Name: ";
                                newInput.id = "debtName" + (i+1);
                                newInput.placeholder = "Enter";
                    
                            } else if (y == 1) {
                               
                                label.for = "debtAmount" +  (i+1);
                                label.innerHTML = "  Debt Amount: ";
                                newInput.id = "debtAmount" +  (i+1);
                                newInput.placeholder = "0";
                    
                            } else if (y == 2) {
                                
                                label.for = "debtInterest" +  (i+1);
                                label.innerHTML = "  Interest Rate(%): ";
                                newInput.id = "debtInterest" +  (i+1);
                                newInput.placeholder = "0";
                                    
                            } else { // y == 3
                             
                                label.for = "debtMin" + (i+1);
                                label.innerHTML = "  Min Monthly Payment: ";
                                newInput.id = "debtMin" + (i+1);
                                newInput.placeholder = "0";
                            }

                            container.appendChild(label);
                            if ((y != 0) && (y != 2)) {
                                var symbolSpan = document.createElement("span");
                                symbolSpan.classList.add("symbol");
                                symbolSpan.textContent = "$";
                                container.appendChild(symbolSpan);
                                newInput.classList.add("dollar-textbox");
                            } else if (y == 2) {
                                newInput.classList.add("percent-textbox");
                            }
                            container.appendChild(newInput);
                            if (y == 2) {
                                var percentSpan = document.createElement("span");
                                percentSpan.classList.add("percent-symbol");
                                percentSpan.textContent = "%";
                                container.appendChild(percentSpan);
                            }
                          
                            container.appendChild(document.createElement("br"));
                                
                        }
                        document.body.appendChild(container);
                        containers.push(container);

                    }
                }
                if (debtNum > 0) {

                    var container2 = document.createElement("div");
                    container2.id = "incContainer";

                    container2.appendChild(document.createElement("br"));


                   

                    var incomeInput = document.createElement("input");
                    incomeInput.classList.add("dollar-textbox");
                    incomeInput.type = "text";
                    incomeInput.name = "dynamicInput";
                    
                    var incomeLabel = document.createElement("label");
                    incomeLabel.for = "income";
                    incomeLabel.innerHTML = "Monthly Debt Payment: ";


                    incomeInput.id = "income";
                    incomeInput.placeholder = "0"; 

                    
                    if (currIncome != undefined) {
                        incomeInput.value = currIncome;
                    }
                  
                    var symbolSpan = document.createElement("span");
                    symbolSpan.classList.add("symbol");
                    symbolSpan.textContent = "$";


                    container2.appendChild(incomeLabel);
                    container2.appendChild(symbolSpan);
                    container2.appendChild(incomeInput);


                    container2.appendChild(document.createElement("br"));
                    document.body.appendChild(container2);

                    
                    var addButton = document.createElement("button");
                    addButton.id = "addButton";
                    addButton.innerHTML = "Calculate";
                    addButton.onclick = function() {
                        calculateDebts(); 
                    };
                    document.body.appendChild(addButton);
                }

            } else {
                alert("Please enter a valid number.");
            }
        }

        function calculateDebtPayoff(TOTAL_DEBT, Total_DoT, debtTime, debtList, totalDebtPaid, schContainer, finalContainer, monthIncome, month) {
            
            while (TOTAL_DEBT > 0) {
            

                if (!isFinite(TOTAL_DEBT)) {
                    var fail = document.createElement('p');
                    fail.innerHTML = `
                                    <p>It's impossible to pay off your debt with that monthly debt payment.</p>
                                    <p>Try increasing your monthly debt payment by cutting back on unnecessary expenses,</p>
                                    <p>increasing your monthly income through getting a higher paying job or working more hours,</p>
                                    <p>committing tax fraud, and/or lowering your interest rate(s) through debt consolidation.</p>
                                    `;
                    finalContainer.appendChild(fail);
                    document.body.appendChild(finalContainer);
                    return 0;
                }

                schContainer.appendChild(document.createElement("br"));

                

                var money_left = monthIncome;
                    
                var text2 = document.createElement("p");
                text2.innerHTML = "Month " + month + ":";
                schContainer.appendChild(text2);

                var text3 = document.createElement('p');
                text3.innerHTML = " STARTING TOTAL DEBT: $" + TOTAL_DEBT.toFixed(2);
                schContainer.appendChild(text3);
                month++;

                // update dict values (min mps and monthly totals )
                // pay min mps
              

                for (var x = 0; x < debtList.length; x++) {
                    // update dictionary values
                    var debt = debtList[x];
                    debt['month_pay'] = 0;
                    if (debt['amount'] < debt['min_mp']) {
                        debt['min_mp'] = debt['amount'];
                    }

                    // pay min mps
                    if (debt['min_mp'] <= money_left) {
                        debt['amount'] -= debt['min_mp'];
                        money_left -= debt['min_mp'];
                        debt['month_pay'] += debt['min_mp'];
                        totalDebtPaid += debt['min_mp'];
                    } else {
                        // min monthly is more than money left
                        debt['amount'] -= money_left;
                        debt['month_pay'] += money_left;
                        totalDebtPaid += money_left;
                        money_left = 0;
                            
                    }
                }
                TOTAL_DEBT = 0;


                // pay BEYOND min mps
                for (var z = 0; z < debtList.length; z++) {
                    var debt = debtList[z];
                    if (debt['amount'] <= money_left) {
                        debt['month_pay'] += debt['amount'];
                        totalDebtPaid += debt['amount'];
                        money_left -= debt['amount'];
                        debt['amount'] = 0;
                    } else {
                        debt['amount'] -= money_left;
                        debt['month_pay'] += money_left;
                        totalDebtPaid += money_left;
                        money_left = 0;
                    }

                    debt['amount'] = parseFloat((debt['amount'] * (1 + (debt['interest'] / 100) / 12)).toFixed(2));

                    TOTAL_DEBT += debt['amount'];   
                    var text4 = document.createElement('p');
                    text4.innerHTML = debt['name'] + " Payment: $" + debt['month_pay'].toFixed(2);
                    

                    if ((debt['month_pay'] == 0) && (debt['amount'] == 0)) {
                        var paidOff = document.createElement('p');
                        paidOff.innerHTML = debt['name'] + ": FULLY PAID OFF";
                        schContainer.appendChild(paidOff);
                    } else {
                        schContainer.appendChild(text4);
                    }
                        
                }
                Total_DoT.push(TOTAL_DEBT);
                debtTime.push(debtList.map(d => d['amount']));
            }
  
            
            schContainer.appendChild(document.createElement("br"));

            var text5 = document.createElement('p');
            text5.innerHTML = "Month " + month + ":";
            schContainer.appendChild(text5);
            
            var text6 = document.createElement('p');
            text6.innerHTML = " DEBT FULLY PAID OFF";
            schContainer.appendChild(text6);
            
            
            
            return [Total_DoT, debtTime, schContainer, totalDebtPaid, month];
        }
    
        function calculateDebts() {


            var schContainer = document.createElement("div");
            schContainer.for = "schContainer";
            schContainer.id = "schContainer";

            Clear();

            var clearButton = document.createElement("button");
            clearButton.id = "clearButton"
            clearButton.innerHTML = "Clear";
            clearButton.onclick = function() {
                Clear(); 
            };
            document.body.appendChild(clearButton);


            var debtList = [];
            var TOTAL_DEBT = 0;
            
     
            for (var i = 1; i <= startDebt; i++) {
                var debtName = document.getElementById("debtName" + i).value;
                var debtAmount = parseFloat(document.getElementById("debtAmount" + i).value.replace(",",""));
                var debtInterest = parseFloat(document.getElementById("debtInterest" + i).value.replace(",",""));
                var debtMin = parseFloat(document.getElementById("debtMin" + i).value.replace(",",""));
                
                if (!isNaN(debtAmount) && !isNaN(debtInterest) && !isNaN(debtMin)) { 
                    var debtInfo = {
                                    'name': debtName,
                                    'amount': debtAmount,
                                    'interest': debtInterest,
                                    'min_mp': debtMin,
                                    'month_pay': 0
                                };

                    debtList.push(debtInfo);
                    TOTAL_DEBT += debtAmount;
                } else {
                    document.body.removeChild(clearButton);
                    if (isNaN(debtAmount)) {
                        alert("Please enter a valid number for \"Debt Amount " + i + ".\"");
                    } else if (isNaN(debtInterest)) {
                        alert("Please enter a valid number for \"Interest Rate " + i + ".\"");
                    } else { //isNaN(debtMin)
                        alert("Please enter a valid number for \"Min Monthly Payment " + i + ".\"");
                    }
                    return 0;
                }
            }

            //var debtListSnowball = debtList;

            debtList.sort((a, b) => interestSort(b) - interestSort(a));

           //debtListSnowball.sort((a, b) => amountSort(b) - amountSort(a));
            
            var totalDebt = document.createElement("p");

            totalDebt.innerHTML = "Starting Total Debt: $" + TOTAL_DEBT;
    
            schContainer.appendChild(totalDebt);

            var scheduleTitle = document.createElement("p");
            totalDebt.innerHTML = "DEBT AVALANCHE SCHEDULE";
            schContainer.appendChild(scheduleTitle);


            var monthIncome = parseFloat(document.getElementById("income").value.replace(",",""));


            if (isNaN(monthIncome)) {
                alert("Please enter a valid number for \"Monthly Debt Payment.\"");
                return 0;
            }


                
            
            // Initialize Values
            var month = 1;
            var Total_DoT = [TOTAL_DEBT];
            var debtTime = [debtList.map(d => d['amount'])];

            var finalContainer = document.createElement('div');
            finalContainer.for = "finalContainer";
            finalContainer.id = "finalContainer";

            
            var initialDebt = TOTAL_DEBT;

     
            
            var avalancheArray = calculateDebtPayoff(TOTAL_DEBT, Total_DoT, debtTime, debtList, 0, schContainer, finalContainer, monthIncome, month);
           

            var Total_DoT = avalancheArray[0];
            var debtTime = avalancheArray[1];
            var schContainer = avalancheArray[2];
            var totalDebtPaid = avalancheArray[3];
            var month = avalancheArray[4];
            

            //var debtTimeSnowball = [debtListSnowball.map(d => d['amount'])];
            //var TOTAL_DEBT_SNOWBALL = TOTAL_DEBT;
            //var Total_DoT_Snowball = Total_DoT;

            //var snowballArray = calculateDebtPayoff(TOTAL_DEBT_SNOWBALL, Total_DoT_Snowball, debtTimeSnowball, 0);

            if (avalancheArray == 0) {
                return 0;
            }

            //Plotting 

            // Create months array 
            var months = []
            for (var i = 1; i <= Total_DoT.length; i++) {
                months.push(i);
            }

            const debtGraph = {
                x: months,
                y: Total_DoT,
                type: 'scatter',
                name: 'Total Debt',
            };

            const debtGraphs = [];
            debtGraphs.push(debtGraph)
            
            for (let i = 0; i < debtList.length; i++) {
                const debtHistory = debtTime.map(debtMonth => debtMonth[i]);
                debtGraphs.push({
                    x: months,
                    y: debtHistory,
                    type: 'scatter',
                    name: debtList[i]['name'],
                    mode: 'lines',
                    line: {
                        dash: 'dash',
                    }
                });
            }

            const layout = {
                title: 'Debt Over Time',

                xaxis: {
                    title: 'Month',
                    range: [1,],
                    fixedrange: true
                    
                },
                yaxis: {
                    title: 'Total Debt',
                    fixedrange: true
                },
            };
            
            var plotlyContainer = document.createElement('div');
            plotlyContainer.id = "Debt Schedule";


            var keyInfoContainer = document.createElement('p');

            var debtPaidMessage = document.createElement('p');
            debtPaidMessage.innerHTML = "Total Debt Paid: $" + totalDebtPaid.toFixed(2).toString();
            keyInfoContainer.appendChild(debtPaidMessage);

            var principalPercentage = (initialDebt / totalDebtPaid) * 100;
            var interestPercentage = ((totalDebtPaid-initialDebt) / totalDebtPaid) * 100;

            var principalPaidMessage = document.createElement('p');
            principalPaidMessage.innerHTML = "Total Pricipal Paid: $" + initialDebt.toFixed(2).toString() + " (" + principalPercentage.toFixed(2).toString() + "%)"; 
            keyInfoContainer.appendChild(principalPaidMessage);

            var interestPaidMessage = document.createElement('p');
            interestPaidMessage.innerHTML = "Total Interest Paid: $" + (totalDebtPaid-initialDebt).toFixed(2).toString() + " (" + interestPercentage.toFixed(2).toString() + "%)"; 
            keyInfoContainer.appendChild(interestPaidMessage);
            

            var debtPaymentTime = document.createElement('p');
            debtPaymentTime.innerHTML = "Debt is Paid Off in " + month.toString() + " Months"; 
            keyInfoContainer.appendChild(debtPaymentTime);

            finalContainer.appendChild(keyInfoContainer);
            finalContainer.appendChild(plotlyContainer);
            finalContainer.appendChild(schContainer);

            document.body.appendChild(finalContainer);
           

            if (debtList.length <= 1) {
                Plotly.newPlot("Debt Schedule", [debtGraph], layout);
            } else {
                Plotly.newPlot("Debt Schedule", debtGraphs, layout);
            }
        }

        function interestSort(debt) {
            return debt['interest'];
        }

        function amountSort(debt) {
            return debt['amount'];
        }

        function Clear() {
            var clButton = document.getElementById("finalContainer");
            var removeButton = document.getElementById("clearButton")
            if (clButton) {
                document.body.removeChild(clButton);
                document.body.removeChild(removeButton);
            }
        }
    </script>
</body>
</html>